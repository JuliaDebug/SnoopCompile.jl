<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Using @snoop_inference to emit manual precompile directives · SnoopCompile</title><meta name="title" content="Using @snoop_inference to emit manual precompile directives · SnoopCompile"/><meta property="og:title" content="Using @snoop_inference to emit manual precompile directives · SnoopCompile"/><meta property="twitter:title" content="Using @snoop_inference to emit manual precompile directives · SnoopCompile"/><meta name="description" content="Documentation for SnoopCompile."/><meta property="og:description" content="Documentation for SnoopCompile."/><meta property="twitter:description" content="Documentation for SnoopCompile."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">SnoopCompile</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">SnoopCompile.jl</a></li><li><span class="tocitem">Basic tutorials</span><ul><li><a class="tocitem" href="../invalidations/">Tutorial on <code>@snoop_invalidations</code></a></li><li><a class="tocitem" href="../snoop_inference/">Tutorial on <code>@snoop_inference</code></a></li><li><a class="tocitem" href="../snoop_llvm/">Tutorial on <code>@snoop_llvm</code></a></li><li><a class="tocitem" href="../pgdsgui/">Profile-guided despecialization</a></li><li><a class="tocitem" href="../jet/">Tutorial on JET integration</a></li></ul></li><li><span class="tocitem">Advanced tutorials</span><ul><li><a class="tocitem" href="../snoop_inference_analysis/">Using <code>@snoop_inference</code> results to improve inferrability</a></li><li class="is-active"><a class="tocitem" href>Using <code>@snoop_inference</code> to emit manual precompile directives</a><ul class="internal"><li><a class="tocitem" href="#SnoopCompile.write"><span>SnoopCompile.write</span></a></li></ul></li></ul></li><li><span class="tocitem">Explanations</span><ul><li><a class="tocitem" href="../../explanations/tools/">Package roles and alternatives</a></li><li><a class="tocitem" href="../../explanations/gotchas/">Precompilation &quot;gotcha&quot;s</a></li><li><a class="tocitem" href="../../explanations/fixing_inference/">Techniques for fixing inference problems</a></li></ul></li><li><a class="tocitem" href="../../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Advanced tutorials</a></li><li class="is-active"><a href>Using <code>@snoop_inference</code> to emit manual precompile directives</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Using <code>@snoop_inference</code> to emit manual precompile directives</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/timholy/SnoopCompile.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/timholy/SnoopCompile.jl/blob/master/docs/src/tutorials/snoop_inference_parcel.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="precompilation"><a class="docs-heading-anchor" href="#precompilation">Using <code>@snoop_inference</code> to emit manual precompile directives</a><a id="precompilation-1"></a><a class="docs-heading-anchor-permalink" href="#precompilation" title="Permalink"></a></h1><p>In a few cases, it may be inconvenient or impossible to precompile using a <a href="https://julialang.github.io/PrecompileTools.jl/stable/#Tutorial:-forcing-precompilation-with-workloads">workload</a>. Some examples might be:</p><ul><li>an application that opens graphical windows</li><li>an application that connects to a database</li><li>an application that creates, deletes, or rewrites files on disk</li></ul><p>In such cases, one alternative is to create a manual list of precompile directives using Julia&#39;s <code>precompile(f, argtypes)</code> function.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>Manual precompile directives are much more likely to &quot;go stale&quot; as the package is developed–-<code>precompile</code> does not throw an error if a method for the given <code>argtypes</code> cannot be found. They are also more likely to be dependent on the Julia version, operating system, or CPU architecture. Whenever possible, it&#39;s safer to use a workload.</p></div></div><p><code>precompile</code> directives have to be emitted by the module that owns the method and/or types. SnoopCompile comes with a tool, <code>parcel</code>, that splits out the &quot;root-most&quot; precompilable MethodInstances into their constituent modules. This will typically correspond to the bottom row of boxes in the <a href="../snoop_inference/#flamegraph">flame graph</a>. In cases where you have some that are not naively precompilable, they will include MethodInstances from higher up in the call tree.</p><p>Let&#39;s use <code>SnoopCompile.parcel</code> on our <a href="../snoop_inference_analysis/#inferrability"><code>OptimizeMe</code></a> demo:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; using SnoopCompileCore, SnoopCompile # here we need the SnoopCompile path for the next line (normally you should wait until after data collection is complete)</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; include(joinpath(pkgdir(SnoopCompile), &quot;examples&quot;, &quot;OptimizeMe.jl&quot;))</code><code class="nohighlight hljs ansi" style="display:block;">Main.var&quot;Main&quot;.OptimizeMe</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; tinf = @snoop_inference OptimizeMe.main();</code><code class="nohighlight hljs ansi" style="display:block;">lotsa containers:</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; ttot, pcs = SnoopCompile.parcel(tinf);</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; ttot</code><code class="nohighlight hljs ansi" style="display:block;">0.08586378599999998</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; pcs</code><code class="nohighlight hljs ansi" style="display:block;">4-element Vector{Pair{Module, Tuple{Float64, Vector{Tuple{Float64, Core.MethodInstance}}}}}:
                                                      Core =&gt; (2.174e-6, [(2.174e-6, MethodInstance for (NamedTuple{(:sizehint,)})(::Tuple{Int64}))])
                                           Base.Multimedia =&gt; (8.146e-6, [(8.146e-6, MethodInstance for MIME(::String))])
                                                      Base =&gt; (0.003206629000000001, [(2.024e-6, MethodInstance for LinearIndices(::Tuple{Base.OneTo{Int64}})), (4.098e-6, MethodInstance for IOContext(::IOContext{Base.PipeEndpoint}, ::Base.ImmutableDict{Symbol, Any})), (5.831e-6, MethodInstance for Base.indexed_iterate(::Tuple{Int64, Int64}, ::Int64, ::Int64)), (5.891e-6, MethodInstance for IOContext(::IOBuffer, ::IOContext{Base.PipeEndpoint})), (6.012e-6, MethodInstance for Base.indexed_iterate(::Tuple{String, Bool}, ::Int64, ::Int64)), (6.401e-6, MethodInstance for Base.indexed_iterate(::Tuple{Any, Int64}, ::Int64, ::Int64)), (6.503e-6, MethodInstance for Base.indexed_iterate(::Pair{Symbol, Any}, ::Int64, ::Int64)), (7.243e-6, MethodInstance for getindex(::Tuple{Base.OneTo{Int64}}, ::Int64)), (7.503e-6, MethodInstance for getindex(::Tuple{Int64, Int64}, ::Int64)), (8.566e-6, MethodInstance for Base.indexed_iterate(::Pair{Symbol, Any}, ::Int64))  …  (2.6179e-5, MethodInstance for getproperty(::DataType, ::Symbol)), (2.7341e-5, MethodInstance for getproperty(::UnionAll, ::Symbol)), (2.9745e-5, MethodInstance for getproperty(::BitVector, ::Symbol)), (3.0978e-5, MethodInstance for getproperty(::Vector, ::Symbol)), (0.00010202099999999999, MethodInstance for LinearIndices(::Vector{Float64})), (0.00030460000000000003, MethodInstance for haskey(::IOContext{Base.PipeEndpoint}, ::Symbol)), (0.000309007, MethodInstance for print(::IOContext{Base.PipeEndpoint}, ::Char)), (0.00034156299999999997, MethodInstance for get(::IOContext{Base.PipeEndpoint}, ::Symbol, ::Type{Any})), (0.00047354000000000005, MethodInstance for get(::IOContext{Base.PipeEndpoint}, ::Symbol, ::Bool)), (0.001367654, MethodInstance for string(::String, ::Int64, ::String))])
 Main.var&quot;Main&quot;.OptimizeMe =&gt; (0.023624046, [(0.000103244, MethodInstance for Main.var&quot;Main&quot;.OptimizeMe.howbig(::Float64)), (0.023520802, MethodInstance for Main.var&quot;Main&quot;.OptimizeMe.main())])</code></pre><p><code>ttot</code> shows the total amount of time spent on type-inference. <code>parcel</code> discovered precompilable MethodInstances for four modules, <code>Core</code>, <code>Base.Multimedia</code>, <code>Base</code>, and <code>OptimizeMe</code> that might benefit from precompile directives. These are listed in increasing order of inference time.</p><p>Let&#39;s look specifically at <code>OptimizeMeFixed</code>, since that&#39;s under our control:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; pcmod = pcs[end]</code><code class="nohighlight hljs ansi" style="display:block;">Main.var&quot;Main&quot;.OptimizeMe =&gt; (0.023624046, Tuple{Float64, Core.MethodInstance}[(0.000103244, MethodInstance for Main.var&quot;Main&quot;.OptimizeMe.howbig(::Float64)), (0.023520802, MethodInstance for Main.var&quot;Main&quot;.OptimizeMe.main())])</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; tmod, tpcs = pcmod.second;</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; tmod</code><code class="nohighlight hljs ansi" style="display:block;">0.023624046</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; tpcs</code><code class="nohighlight hljs ansi" style="display:block;">2-element Vector{Tuple{Float64, Core.MethodInstance}}:
 (0.000103244, MethodInstance for Main.var&quot;Main&quot;.OptimizeMe.howbig(::Float64))
 (0.023520802, MethodInstance for Main.var&quot;Main&quot;.OptimizeMe.main())</code></pre><p>This indicates the amount of time spent specifically on <code>OptimizeMe</code>, plus the list of calls that could be precompiled in that module.</p><p>We could look at the other modules (packages) similarly.</p><h2 id="SnoopCompile.write"><a class="docs-heading-anchor" href="#SnoopCompile.write">SnoopCompile.write</a><a id="SnoopCompile.write-1"></a><a class="docs-heading-anchor-permalink" href="#SnoopCompile.write" title="Permalink"></a></h2><p>You can generate files that contain ready-to-use <code>precompile</code> directives using <code>SnoopCompile.write</code>:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; SnoopCompile.write(&quot;/tmp/precompiles_OptimizeMe&quot;, pcs)</code><code class="nohighlight hljs ansi" style="display:block;">Core: no precompile statements out of 2.174e-6
Base.Multimedia: no precompile statements out of 8.146e-6
Base: precompiled 0.001367654 out of 0.003206629000000001
Main.var&quot;Main&quot;.OptimizeMe: precompiled 0.023520802 out of 0.023624046</code></pre><p>You&#39;ll now find a directory <code>/tmp/precompiles_OptimizeMe</code>, and inside you&#39;ll find files for modules that could have precompile directives added manually. The contents of the last of these should be recognizable:</p><pre><code class="language-julia hljs">function _precompile_()
    ccall(:jl_generating_output, Cint, ()) == 1 || return nothing
    Base.precompile(Tuple{typeof(main)})   # time: 0.4204474
end</code></pre><p>The first <code>ccall</code> line ensures we only pay the cost of running these <code>precompile</code> directives if we&#39;re building the package; this is relevant mostly if you&#39;re running Julia with <code>--compiled-modules=no</code>, which can be a convenient way to disable precompilation and examine packages in their &quot;native state.&quot; (It would also matter if you&#39;ve set <code>__precompile__(false)</code> at the top of your module, but if so why are you reading this?)</p><p>This file is ready to be moved into the <code>OptimizeMe</code> repository and <code>include</code>d into your module definition.</p><p>You might also consider submitting some of the other files (or their <code>precompile</code> directives) to the packages you depend on.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../snoop_inference_analysis/">« Using <code>@snoop_inference</code> results to improve inferrability</a><a class="docs-footer-nextpage" href="../../explanations/tools/">Package roles and alternatives »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.9.0 on <span class="colophon-date" title="Thursday 20 March 2025 14:20">Thursday 20 March 2025</span>. Using Julia version 1.11.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
