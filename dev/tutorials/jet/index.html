<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tutorial on JET integration · SnoopCompile</title><meta name="title" content="Tutorial on JET integration · SnoopCompile"/><meta property="og:title" content="Tutorial on JET integration · SnoopCompile"/><meta property="twitter:title" content="Tutorial on JET integration · SnoopCompile"/><meta name="description" content="Documentation for SnoopCompile."/><meta property="og:description" content="Documentation for SnoopCompile."/><meta property="twitter:description" content="Documentation for SnoopCompile."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">SnoopCompile</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">SnoopCompile.jl</a></li><li><span class="tocitem">Basic tutorials</span><ul><li><a class="tocitem" href="../invalidations/">Tutorial on <code>@snoop_invalidations</code></a></li><li><a class="tocitem" href="../snoop_inference/">Tutorial on <code>@snoop_inference</code></a></li><li><a class="tocitem" href="../snoop_llvm/">Tutorial on <code>@snoop_llvm</code></a></li><li><a class="tocitem" href="../pgdsgui/">Profile-guided despecialization</a></li><li class="is-active"><a class="tocitem" href>Tutorial on JET integration</a><ul class="internal"><li><a class="tocitem" href="#JET-usage"><span>JET usage</span></a></li><li><a class="tocitem" href="#JET-limitations"><span>JET limitations</span></a></li><li><a class="tocitem" href="#JET/SnoopCompile-integration"><span>JET/SnoopCompile integration</span></a></li></ul></li></ul></li><li><span class="tocitem">Advanced tutorials</span><ul><li><a class="tocitem" href="../snoop_inference_analysis/">Using <code>@snoop_inference</code> results to improve inferrability</a></li><li><a class="tocitem" href="../snoop_inference_parcel/">Using <code>@snoop_inference</code> to emit manual precompile directives</a></li></ul></li><li><span class="tocitem">Explanations</span><ul><li><a class="tocitem" href="../../explanations/tools/">Package roles and alternatives</a></li><li><a class="tocitem" href="../../explanations/gotchas/">Precompilation &quot;gotcha&quot;s</a></li><li><a class="tocitem" href="../../explanations/fixing_inference/">Techniques for fixing inference problems</a></li></ul></li><li><a class="tocitem" href="../../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Basic tutorials</a></li><li class="is-active"><a href>Tutorial on JET integration</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tutorial on JET integration</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/timholy/SnoopCompile.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/timholy/SnoopCompile.jl/blob/master/docs/src/tutorials/jet.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Tutorial-on-JET-integration"><a class="docs-heading-anchor" href="#Tutorial-on-JET-integration">Tutorial on JET integration</a><a id="Tutorial-on-JET-integration-1"></a><a class="docs-heading-anchor-permalink" href="#Tutorial-on-JET-integration" title="Permalink"></a></h1><p><a href="https://github.com/aviatesk/JET.jl">JET</a> is a powerful tool for analyzing your code. As described <a href="../../explanations/tools/#JET">elsewhere</a>, some of its functionality overlaps SnoopCompile, but its mechanism of action is very different. The combination JET and SnoopCompile provides capabilities that neither package has on its own. Specifically, one can use SnoopCompile to collect data on the full callgraph and JET to perform the exhaustive analysis of individual nodes.</p><p>The integration between the two packages is bundled into SnoopCompile, specifically <a href="../../reference/#SnoopCompile.report_callee"><code>report_callee</code></a>, <a href="../../reference/#SnoopCompile.report_callees"><code>report_callees</code></a>, and <a href="../../reference/#SnoopCompile.report_caller"><code>report_caller</code></a>. These take <a href="../../reference/#SnoopCompile.InferenceTrigger"><code>InferenceTrigger</code></a> (see the page on <a href="../snoop_inference_analysis/#inferrability">inference failures</a>) and use them to generate JET reports. These tools focus on error-analysis rather than optimization, as SnoopCompile can already identify runtime dispatch.</p><p>We can demonstrate both the need and use of these tools with a simple extended example.</p><h2 id="JET-usage"><a class="docs-heading-anchor" href="#JET-usage">JET usage</a><a id="JET-usage-1"></a><a class="docs-heading-anchor-permalink" href="#JET-usage" title="Permalink"></a></h2><p>As a basic introduction to JET, let&#39;s analyze the following call from JET&#39;s own documentation:</p><pre><code class="language-julia-repl hljs">julia&gt; using JET

julia&gt; list = Any[1,2,3];

julia&gt; sum(list)
6

julia&gt; @report_call sum(list)
═════ 1 possible error found ═════
┌ sum(a::Vector{Any}) @ Base ./reducedim.jl:1010
│┌ sum(a::Vector{Any}; dims::Colon, kw::@Kwargs{}) @ Base ./reducedim.jl:1010
││┌ _sum(a::Vector{Any}, ::Colon) @ Base ./reducedim.jl:1014
│││┌ _sum(a::Vector{Any}, ::Colon; kw::@Kwargs{}) @ Base ./reducedim.jl:1014
││││┌ _sum(f::typeof(identity), a::Vector{Any}, ::Colon) @ Base ./reducedim.jl:1015
│││││┌ _sum(f::typeof(identity), a::Vector{Any}, ::Colon; kw::@Kwargs{}) @ Base ./reducedim.jl:1015
││││││┌ mapreduce(f::typeof(identity), op::typeof(Base.add_sum), A::Vector{Any}) @ Base ./reducedim.jl:357
│││││││┌ mapreduce(f::typeof(identity), op::typeof(Base.add_sum), A::Vector{Any}; dims::Colon, init::Base._InitialValue) @ Base ./reducedim.jl:357
││││││││┌ _mapreduce_dim(f::typeof(identity), op::typeof(Base.add_sum), ::Base._InitialValue, A::Vector{Any}, ::Colon) @ Base ./reducedim.jl:365
│││││││││┌ _mapreduce(f::typeof(identity), op::typeof(Base.add_sum), ::IndexLinear, A::Vector{Any}) @ Base ./reduce.jl:432
││││││││││┌ mapreduce_empty_iter(f::typeof(identity), op::typeof(Base.add_sum), itr::Vector{Any}, ItrEltype::Base.HasEltype) @ Base ./reduce.jl:380
│││││││││││┌ reduce_empty_iter(op::Base.MappingRF{typeof(identity), typeof(Base.add_sum)}, itr::Vector{Any}, ::Base.HasEltype) @ Base ./reduce.jl:384
││││││││││││┌ reduce_empty(op::Base.MappingRF{typeof(identity), typeof(Base.add_sum)}, ::Type{Any}) @ Base ./reduce.jl:361
│││││││││││││┌ mapreduce_empty(::typeof(identity), op::typeof(Base.add_sum), T::Type{Any}) @ Base ./reduce.jl:372
││││││││││││││┌ reduce_empty(::typeof(Base.add_sum), ::Type{Any}) @ Base ./reduce.jl:352
│││││││││││││││┌ reduce_empty(::typeof(+), ::Type{Any}) @ Base ./reduce.jl:343
││││││││││││││││┌ zero(::Type{Any}) @ Base ./missing.jl:106
│││││││││││││││││ MethodError: no method matching zero(::Type{Any}): Base.throw(Base.MethodError(zero, tuple(Base.Any)::Tuple{DataType})::MethodError)
││││││││││││││││└────────────────────</code></pre><p>The final line reveals that while <code>sum</code> happened to work for the specific <code>list</code> we provided, it nevertheless has a &quot;gotcha&quot; for the types we supplied: if <code>list</code> happens to be empty, <code>sum</code> depends on the ability to generate <code>zero(T)</code> for the element-type <code>T</code> of <code>list</code>, but because we constructed <code>list</code> to have an element-type of <code>Any</code>, there is no such method and <code>sum(Any[])</code> throws an error:</p><pre><code class="language-julia-repl hljs">julia&gt; sum(Int[])
0

julia&gt; sum(Any[])
ERROR: MethodError: no method matching zero(::Type{Any})
[...]</code></pre><p>(This can be circumvented with <code>sum(Any[]; init=0)</code>.)</p><p>This is the kind of bug that can lurk undetected for a long time, and JET excels at exposing them.</p><h2 id="JET-limitations"><a class="docs-heading-anchor" href="#JET-limitations">JET limitations</a><a id="JET-limitations-1"></a><a class="docs-heading-anchor-permalink" href="#JET-limitations" title="Permalink"></a></h2><p>JET is a <em>static</em> analyzer, meaning that it works from the argument types provided, and that has an important consequence: if a particular callee can&#39;t be inferred, JET can&#39;t analyze it. We can illustrate that quite easily:</p><pre><code class="language-julia-repl hljs">julia&gt; callsum(listcontainer) = sum(listcontainer[1])
callsum (generic function with 1 method)

julia&gt; lc = Any[list];   # &quot;hide&quot; `list` inside a Vector{Any}

julia&gt; callsum(lc)
6

julia&gt; @report_call callsum(lc)
No errors detected</code></pre><p>Because we &quot;hid&quot; the type of <code>list</code> from inference, JET couldn&#39;t tell what specific instance of <code>sum</code> was going to be called, so it was unable to detect any errors.</p><h2 id="JET/SnoopCompile-integration"><a class="docs-heading-anchor" href="#JET/SnoopCompile-integration">JET/SnoopCompile integration</a><a id="JET/SnoopCompile-integration-1"></a><a class="docs-heading-anchor-permalink" href="#JET/SnoopCompile-integration" title="Permalink"></a></h2><p>A resolution to this problem is to use SnoopCompile to do the &quot;data collection&quot; and JET to do the analysis. The key reason is that SnoopCompile is a dynamic analyzer, and is capable of bridging across runtime dispatch. As always, you need to do the data collection in a fresh session where the calls have not previously been inferred. After restarting Julia, we can do this:</p><pre><code class="language-julia hljs">julia&gt; using SnoopCompileCore

julia&gt; list = Any[1,2,3];

julia&gt; lc = Any[list];   # &quot;hide&quot; `list` inside a Vector{Any}

julia&gt; callsum(listcontainer) = sum(listcontainer[1]);

julia&gt; tinf = @snoop_inference callsum(lc);

julia&gt; using SnoopCompile, JET, Cthulhu

julia&gt; tinf.children
2-element Vector{SnoopCompileCore.InferenceTimingNode}:
 InferenceTimingNode: 0.000869/0.000869 on callsum(::Vector{Any}) with 0 direct children
 InferenceTimingNode: 0.000196/0.006685 on sum(::Vector{Any}) with 1 direct children

julia&gt; report_callees(inference_triggers(tinf))
1-element Vector{Pair{InferenceTrigger, JET.JETCallResult{JET.JETAnalyzer{JET.BasicPass}, Base.Pairs{Symbol, Union{}, Tuple{}, @NamedTuple{}}}}}:
 Inference triggered to call sum(::Vector{Any}) from callsum (./REPL[5]:1) with specialization callsum(::Vector{Any}) =&gt; ═════ 1 possible error found ═════
┌ sum(a::Vector{Any}) @ Base ./reducedim.jl:1010
│┌ sum(a::Vector{Any}; dims::Colon, kw::@Kwargs{}) @ Base ./reducedim.jl:1010
││┌ _sum(a::Vector{Any}, ::Colon) @ Base ./reducedim.jl:1014
│││┌ _sum(a::Vector{Any}, ::Colon; kw::@Kwargs{}) @ Base ./reducedim.jl:1014
││││┌ _sum(f::typeof(identity), a::Vector{Any}, ::Colon) @ Base ./reducedim.jl:1015
│││││┌ _sum(f::typeof(identity), a::Vector{Any}, ::Colon; kw::@Kwargs{}) @ Base ./reducedim.jl:1015
││││││┌ mapreduce(f::typeof(identity), op::typeof(Base.add_sum), A::Vector{Any}) @ Base ./reducedim.jl:357
│││││││┌ mapreduce(f::typeof(identity), op::typeof(Base.add_sum), A::Vector{Any}; dims::Colon, init::Base._InitialValue) @ Base ./reducedim.jl:357
││││││││┌ _mapreduce_dim(f::typeof(identity), op::typeof(Base.add_sum), ::Base._InitialValue, A::Vector{Any}, ::Colon) @ Base ./reducedim.jl:365
│││││││││┌ _mapreduce(f::typeof(identity), op::typeof(Base.add_sum), ::IndexLinear, A::Vector{Any}) @ Base ./reduce.jl:432
││││││││││┌ mapreduce_empty_iter(f::typeof(identity), op::typeof(Base.add_sum), itr::Vector{Any}, ItrEltype::Base.HasEltype) @ Base ./reduce.jl:380
│││││││││││┌ reduce_empty_iter(op::Base.MappingRF{typeof(identity), typeof(Base.add_sum)}, itr::Vector{Any}, ::Base.HasEltype) @ Base ./reduce.jl:384
││││││││││││┌ reduce_empty(op::Base.MappingRF{typeof(identity), typeof(Base.add_sum)}, ::Type{Any}) @ Base ./reduce.jl:361
│││││││││││││┌ mapreduce_empty(::typeof(identity), op::typeof(Base.add_sum), T::Type{Any}) @ Base ./reduce.jl:372
││││││││││││││┌ reduce_empty(::typeof(Base.add_sum), ::Type{Any}) @ Base ./reduce.jl:352
│││││││││││││││┌ reduce_empty(::typeof(+), ::Type{Any}) @ Base ./reduce.jl:343
││││││││││││││││┌ zero(::Type{Any}) @ Base ./missing.jl:106
│││││││││││││││││ MethodError: no method matching zero(::Type{Any}): Base.throw(Base.MethodError(zero, tuple(Base.Any)::Tuple{DataType})::MethodError)
││││││││││││││││└────────────────────</code></pre><p>Because SnoopCompileCore collected the runtime-dispatched <code>sum</code> call, we can pass it to JET. <code>report_callees</code> filters those calls which generate JET reports, allowing you to focus on potential errors.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>JET integration is enabled only if JET.jl <em>and</em> Cthulhu.jl have been loaded into your main session. This is why there&#39;s the <code>using JET, Cthulhu</code> statement included in the example given.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../pgdsgui/">« Profile-guided despecialization</a><a class="docs-footer-nextpage" href="../snoop_inference_analysis/">Using <code>@snoop_inference</code> results to improve inferrability »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Wednesday 24 July 2024 16:09">Wednesday 24 July 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
